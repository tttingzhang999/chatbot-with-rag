version: '3.8'

services:
  # HR Chatbot Backend Lambda
  backend:
    image: hr-chatbot-backend:latest
    container_name: hr-chatbot-backend
    ports:
      - "9000:8080"  # Direct Lambda access for debugging
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=postgresql://postgres:postgres@host.docker.internal:5432/hr_chatbot
      - SECRET_KEY=uJgxTBmfHodx5difgGadv_nD3u52NNILV6XZCMYCM4s
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    depends_on:
      - lite-hub
    healthcheck:
      test: ["CMD", "curl", "-f", "http://lite-hub:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # HR Chatbot Frontend (普通容器 + Uvicorn)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: hr-chatbot-frontend
    ports:
      - "7860:7860"  # Gradio 默認端口
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      # Frontend 通過 lite-hub 與 backend 通信
      - BACKEND_API_URL=http://lite-hub:3000
    restart: unless-stopped
    depends_on:
      - backend
      - lite-hub
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7860/info/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # LiteHub - API Gateway Mock
  lite-hub:
    restart: always
    build:
      context: ./lite-hub
      dockerfile: Dockerfile
    container_name: lite-hub
    ports:
      - "3000:3000"  # HTTP API Gateway
      - "3001:3001"  # WebSocket API Gateway
      - "3002:3002"  # Lambda Invoke API
    environment:
      # Map logical function names to container endpoints
      - FUNCTION_ENDPOINT=backend=http://backend:8080
      - PATH_MAPPING=/health=backend,/chat=backend,/auth=backend,/upload=backend,/docs=backend,/openapi.json=backend
      - CORS_ALLOW_ORIGIN=http://localhost:5173,http://localhost:8000,http://localhost:3000
      # Use AWS API Gateway v2 payload format (default)
      # - HTTP_V1_PAYLOAD_FUNCTIONS=  # uncomment if you need v1 format
    stop_grace_period: 1s

networks:
  default:
    name: hr-chatbot-network
